networks:
  homelab:
    # primary shared network for most services
    name: homelab
    driver: bridge
  homelab_proxy:
    # external reverse-proxy network
    name: homelab_proxy
    driver: bridge

services:
  # ----------------------------
  # CORE SMART-HOME STACK
  # ----------------------------

  home-assistant:
    image: lscr.io/linuxserver/homeassistant:latest
    container_name: home-assistant
    volumes:
      - ./config/homeassistant:/config
      - ${MEDIA}:/media
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    restart: unless-stopped
    network_mode: host # needs host networking for discovery/integrations
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.homeassistant.rule=Host(`homeassistant.${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.homeassistant.entrypoints=websecure"
      - "traefik.http.routers.homeassistant.tls.certresolver=cloudflare"
      - "traefik.http.routers.homeassistant.middlewares=authelia@docker"
      - "traefik.http.services.homeassistant.loadbalancer.server.url=http://host.docker.internal:8123"

  mqtt:
    image: eclipse-mosquitto:latest
    container_name: mqtt
    restart: unless-stopped
    volumes:
      - ./config/mosquitto/data:/mosquitto/data
      - ./config/mosquitto/log:/mosquitto/log
      - ./config/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf
    networks:
      - homelab

  zigbee2mqtt:
    image: koenkk/zigbee2mqtt
    container_name: zigbee2mqtt
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - ZIGBEE2MQTT_CONFIG_MQTT_SERVER=${MQTT_SERVER}
      - ZIGBEE2MQTT_CONFIG_MQTT_USER=${MQTT_USER}
      - ZIGBEE2MQTT_CONFIG_MQTT_PASSWORD=${MQTT_PASSWORD}
    volumes:
      - /run/udev:/run/udev:ro
      - ./config/zigbee2mqtt:/app/data
    devices:
      - ${ZIGBEE_ADAPTOR_PATH}:/dev/ttyUSB0
    networks:
      - homelab
      - homelab_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=homelab_proxy"
      - "traefik.http.routers.zigbee2mqtt.rule=Host(`zigbee2mqtt.${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.zigbee2mqtt.entrypoints=websecure"
      - "traefik.http.routers.zigbee2mqtt.tls.certresolver=cloudflare"
      - "traefik.http.routers.zigbee2mqtt.middlewares=authentik@docker"
      - "traefik.http.services.zigbee2mqtt.loadbalancer.server.port=8099"

  # ----------------------------
  # MONITORING & METRICS
  # ----------------------------

  uptime-kuma:
    image: louislam/uptime-kuma
    container_name: uptime-kuma
    volumes:
      - ./data/uptime-kuma:/app/data
      - /var/run/docker.sock:/var/run/docker.sock
    restart: always
    networks:
      - homelab
      - homelab_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=homelab_proxy"
      - "traefik.http.routers.uptime-kuma.rule=Host(`uptime-kuma.${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.uptime-kuma.entrypoints=websecure"
      - "traefik.http.routers.uptime-kuma.tls.certresolver=cloudflare"
      - "traefik.http.routers.uptime-kuma.middlewares=authentik@docker"
      - "traefik.http.services.uptime-kuma.loadbalancer.server.port=3001"

  prometheus:
    image: prom/prometheus
    container_name: prometheus
    user: "1000"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Asia/Tokyo
    ports:
      - "9090:9090"
    restart: unless-stopped
    volumes:
      - ./config/prometheus:/etc/prometheus
      - ./data/prometheus:/prometheus
    networks:
      - homelab
      - homelab_proxy

  node_exporter:
    image: quay.io/prometheus/node-exporter:latest
    container_name: node_exporter
    command:
      - '--path.rootfs=/host'
    network_mode: host
    pid: host
    restart: unless-stopped
    volumes:
      - '/:/host:ro,rslave'

  cadvisor:
    image: gcr.io/cadvisor/cadvisor
    container_name: cadvisor
    ports:
      - "8080:8080"
    environment:
      - TZ=Asia/Tokyo
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    command:
      - '-housekeeping_interval=30s'
      - '-docker_only=true'
      - '-store_container_labels=false'
      - '-disable_metrics=percpu,process,sched,tcp,udp,diskIO,disk,network'
    privileged: true
    devices:
      - /dev/kmsg
    restart: unless-stopped
    networks:
      - homelab

  grafana:
    image: grafana/grafana
    container_name: grafana
    user: "1000"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Asia/Tokyo
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - ./data/grafana:/var/lib/grafana
    restart: unless-stopped
    networks:
      - homelab
      - homelab_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=homelab_proxy"
      - "traefik.http.routers.grafana.rule=Host(`grafana.${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.grafana.entrypoints=websecure"
      - "traefik.http.routers.grafana.tls.certresolver=cloudflare"
      - "traefik.http.routers.grafana.middlewares=authentik@docker"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"

  loki:
    image: grafana/loki:2.9.4
    container_name: loki
    command: -config.file=/etc/loki/local-config.yaml
    user: "1000:1000"
    volumes:
      - ./config/loki:/etc/loki
      - ./data/loki:/loki
    restart: unless-stopped
    networks:
      - homelab

  promtail:
    image: grafana/promtail:2.9.4
    container_name: promtail
    command: -config.file=/etc/promtail/config.yaml
    volumes:
      - ./config/promtail:/etc/promtail
      - ./data/promtail:/tmp
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped
    depends_on:
      - loki
    networks:
      - homelab

  glances:
    image: nicolargo/glances:latest-full
    container_name: glances
    restart: unless-stopped
    pid: host
    environment:
      - GLANCES_OPT=-w --disable-check-update
      - TZ=${TZ}
    volumes:
      - /:/host:ro
      - /mnt/media:/mnt/media:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - homelab
      - homelab_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=homelab_proxy"
      - "traefik.http.routers.glances.rule=Host(`glances.${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.glances.entrypoints=websecure"
      - "traefik.http.routers.glances.tls.certresolver=cloudflare"
      - "traefik.http.routers.glances.middlewares=authentik@docker"
      - "traefik.http.services.glances.loadbalancer.server.port=61208"

  # ----------------------------
  # VPN (NORDLYNX) + MEDIA DOWNLOADS VIA VPN
  # ----------------------------

  nordlynx:
    image: ghcr.io/bubuntux/nordlynx
    container_name: nordlynx
    cap_add:
      - NET_ADMIN
    environment:
      - PRIVATE_KEY=${NORDVPN_PRIVATE_KEY}
      - NET_LOCAL=${LOCAL_NETWORK} # e.g., 192.168.0.0/16
    # Publish ports for any services sharing this network namespace (below)
    ports:
      - "51413:51413"
      - "51413:51413/udp"
      - "9091:9091" # Transmission Web UI
      - "9696:9696" # Prowlarr Web UI
    restart: unless-stopped
    networks:
      - homelab
      - homelab_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=homelab_proxy"
      - "traefik.http.routers.transmission.rule=Host(`transmission.${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.transmission.entrypoints=websecure"
      - "traefik.http.routers.transmission.service=transmission"
      - "traefik.http.routers.transmission.tls.certresolver=cloudflare"
      - "traefik.http.routers.transmission.middlewares=authentik@docker"
      - "traefik.http.services.transmission.loadbalancer.server.port=9091"
      - "traefik.http.routers.prowlarr.rule=Host(`prowlarr.${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.prowlarr.entrypoints=websecure"
      - "traefik.http.routers.prowlarr.service=prowlarr"
      - "traefik.http.routers.prowlarr.tls.certresolver=cloudflare"
      - "traefik.http.routers.prowlarr.middlewares=authentik@docker"
      - "traefik.http.services.prowlarr.loadbalancer.server.port=9696"

  transmission:
    image: lscr.io/linuxserver/transmission:latest
    container_name: transmission
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      # - TRANSMISSION_WEB_HOME=/flood-for-transmission/ #optional
    volumes:
      - ./config/transmission:/config
      - ${DOWNLOADS}:/downloads
      - ${WATCH}:/watch
    # Route ALL traffic through VPN by sharing network namespace
    network_mode: service:nordlynx
    depends_on:
      - nordlynx
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "ping", "-c", "1", "google.com" ]
      interval: 1m30s
      timeout: 10s
      retries: 3
      start_period: 10s

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - DOCKER_MODS=ghcr.io/gilbn/theme.park:prowlarr
      - TP_THEME=overseerr
    volumes:
      - ./config/prowlarr:/config
    # Route ALL traffic through VPN by sharing network namespace
    network_mode: service:nordlynx
    depends_on:
      - nordlynx
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "ping", "-c", "1", "google.com" ]
      interval: 1m30s
      timeout: 10s
      retries: 3
      start_period: 10s

  sonarr:
    image: lscr.io/linuxserver/sonarr
    container_name: sonarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - DOCKER_MODS=ghcr.io/gilbn/theme.park:sonarr
      - TP_THEME=overseerr
    volumes:
      - ./config/sonarr:/config
      - ${TV}:/tv
      - ${DOWNLOADS}:/downloads
    depends_on:
      - prowlarr
      - transmission
    restart: unless-stopped
    networks:
      - homelab
      - homelab_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=homelab_proxy"
      - "traefik.http.routers.sonarr.rule=Host(`sonarr.${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.sonarr.entrypoints=websecure"
      - "traefik.http.routers.sonarr.tls.certresolver=cloudflare"
      - "traefik.http.routers.sonarr.middlewares=authentik@docker"
      - "traefik.http.services.sonarr.loadbalancer.server.port=8989"

  radarr:
    image: lscr.io/linuxserver/radarr
    container_name: radarr
    hostname: radarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - DOCKER_MODS=ghcr.io/gilbn/theme.park:radarr
      - TP_THEME=overseerr
    volumes:
      - ./config/radarr:/config
      - ${MOVIES}:/movies
      - ${DOWNLOADS}:/downloads
    depends_on:
      - prowlarr
      - transmission
    restart: unless-stopped
    networks:
      - homelab
      - homelab_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=homelab_proxy"
      - "traefik.http.routers.radarr.rule=Host(`radarr.${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.radarr.entrypoints=websecure"
      - "traefik.http.routers.radarr.tls.certresolver=cloudflare"
      - "traefik.http.routers.radarr.middlewares=authentik@docker"
      - "traefik.http.services.radarr.loadbalancer.server.port=7878"

  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - DOCKER_MODS=ghcr.io/gilbn/theme.park:bazarr
      - TP_THEME=overseerr
    volumes:
      - ./config/bazarr:/config
      - ${MOVIES}:/movies
      - ${TV}:/tv
    restart: unless-stopped
    networks:
      - homelab
      - homelab_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=homelab_proxy"
      - "traefik.http.routers.bazarr.rule=Host(`bazarr.${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.bazarr.entrypoints=websecure"
      - "traefik.http.routers.bazarr.tls.certresolver=cloudflare"
      - "traefik.http.routers.bazarr.middlewares=authentik@docker"
      - "traefik.http.services.bazarr.loadbalancer.server.port=6767"

  # ----------------------------
  # MEDIA SERVING & DISCOVERY
  # ----------------------------

  plex:
    image: lscr.io/linuxserver/plex
    container_name: plex
    network_mode: host # best for DLNA, HW accel, discovery
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - version=docker
      - DOCKER_MODS=ghcr.io/gilbn/theme.park:plex
      - TP_THEME=overseerr
    volumes:
      - ./config/plex:/config
      - ${MEDIA}:/media
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.plex.rule=Host(`plex.${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.plex.entrypoints=websecure"
      - "traefik.http.routers.plex.tls.certresolver=cloudflare"
      # âš ï¸ Strongly recommend NO Authentik in front of Plex (breaks many clients) 
      # - "traefik.http.routers.plex.middlewares=authentik@docker"
      - "traefik.http.services.plex.loadbalancer.server.url=http://host.docker.internal:32400"

  overseerr:
    image: lscr.io/linuxserver/overseerr:latest
    container_name: overseerr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./config/overseerr:/config # fixed path name
    restart: unless-stopped
    networks:
      - homelab
      - homelab_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=homelab_proxy"
      - "traefik.http.routers.overseerr.rule=Host(`overseerr.${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.overseerr.entrypoints=websecure"
      - "traefik.http.routers.overseerr.tls.certresolver=cloudflare"
      - "traefik.http.routers.overseerr.middlewares=authentik@docker"
      - "traefik.http.services.overseerr.loadbalancer.server.port=5055"

  # ----------------------------
  # BOOKS / LIBRARY
  # ----------------------------

  calibre-web-automated:
    image: crocodilestick/calibre-web-automated:latest
    container_name: calibre-web-automated
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./config/calibre-web:/config
      - ${LIBRARY}:/calibre-library
      - ${BOOK_INGEST}:/cwa-book-ingest # ingest dir; files removed after processing
    restart: unless-stopped
    networks:
      - homelab
      - homelab_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=homelab_proxy"
      - "traefik.http.routers.calibre-web.rule=Host(`calibre-web.${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.calibre-web.entrypoints=websecure"
      - "traefik.http.routers.calibre-web.tls.certresolver=cloudflare"
      - "traefik.http.routers.calibre-web.middlewares=authentik@docker"
      - "traefik.http.services.calibre-web.loadbalancer.server.port=8083"

  # ----------------------------
  # SYNC
  # ----------------------------

  syncthing:
    image: syncthing/syncthing
    container_name: syncthing
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    ports:
      - "22000:22000/tcp" # sync
      - "22000:22000/udp"
      - "21027:21027/udp" # discovery
      # GUI (8384) can be proxied on homelab_proxy; publish if you need host access:
      # - "8384:8384"
    volumes:
      - ./config/syncthing:/var/syncthing/config
      - ${SAVES}:/var/syncthing/data
    networks:
      - homelab
      - homelab_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=homelab_proxy"
      - "traefik.http.routers.syncthing.rule=Host(`syncthing.${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.syncthing.entrypoints=websecure"
      - "traefik.http.routers.syncthing.tls.certresolver=cloudflare"
      - "traefik.http.routers.syncthing.middlewares=authentik@docker"
      - "traefik.http.services.syncthing.loadbalancer.server.port=8384"
  # ----------------------------
  # SIYUAN
  # ----------------------------

  siyuan:
    image: b3log/siyuan
    container_name: siyuan
    command:
      - '--workspace=/siyuan/workspace/'
    ports:
      - 6806:6806
    volumes:
      - ./config/siyuan/workspace:/siyuan/workspace
    restart: unless-stopped
    environment:
      # A list of time zone identifiers can be found at https://en.wikipedia.org/wiki/List_of_tz_database_time_zones
      - TZ=${TZ}
      - PUID=${PUID}  # Customize user ID
      - PGID=${PGID}  # Customize group ID
      # - SIYUAN_ACCESS_AUTH_CODE=${SIYUAN_ACCESS_AUTH_CODE}
      - SIYUAN_ACCESS_AUTH_CODE_BYPASS=${SIYUAN_ACCESS_AUTH_CODE_BYPASS}
    networks:
      - homelab
      - homelab_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=homelab_proxy"
      - "traefik.http.routers.siyuan.rule=Host(`siyuan.${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.siyuan.entrypoints=websecure"
      - "traefik.http.routers.siyuan.tls.certresolver=cloudflare"
      - "traefik.http.routers.siyuan.middlewares=authentik@docker"
      - "traefik.http.services.siyuan.loadbalancer.server.port=6806"

  # ----------------------------
  # UTILITIES
  # ----------------------------

  postgres:
    restart: on-failure
    image: pgvector/pgvector:pg16
    environment:
      - POSTGRES_SUPERUSER=${POSTGRES_SUPERUSER:-postgres}
      - POSTGRES_DB_SUPERUSER=${POSTGRES_DB_SUPERUSER:-postgres}
      - POSTGRES_PASSWORD_SUPERUSER=${POSTGRES_PASSWORD_SUPERUSER:-password}
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
    healthcheck:
      test: [ "CMD", "pg_isready", "-U", "${POSTGRES_SUPERUSER}", "-d", "${POSTGRES_DB_SUPERUSER}" ]
      interval: 5s
      timeout: 5s
      retries: 12
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - homelab

  pgadmin:
    restart: unless-stopped
    image: dpage/pgadmin4:latest
    environment:
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_DEFAULT_EMAIL}
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_DEFAULT_PASSWORD}
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - homelab
      - homelab_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=homelab_proxy"
      - "traefik.http.routers.pgadmin.rule=Host(`pgadmin.${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.pgadmin.entrypoints=websecure"
      - "traefik.http.routers.pgadmin.tls.certresolver=cloudflare"
      - "traefik.http.routers.pgadmin.middlewares=authentik@docker"
      - "traefik.http.services.pgadmin.loadbalancer.server.port=80"
  flaresolverr:
    # DockerHub mirror flaresolverr/flaresolverr:latest
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_HTML=${LOG_HTML:-false}
      - CAPTCHA_SOLVER=${CAPTCHA_SOLVER:-none}
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    ports:
      - "8191:8191"
    restart: unless-stopped
    networks:
      - homelab
      - homelab_proxy
    # portal to access all other web UI
  homepage:
    container_name: homepage
    restart: unless-stopped
    image: ghcr.io/gethomepage/homepage:latest
    volumes:
      - ./config/homepage:/app/config
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - HOMEPAGE_ALLOWED_HOSTS=homepage.antoineglacet.com
    networks:
      - homelab
      - homelab_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=homelab_proxy"
      - "traefik.http.routers.homepage.rule=Host(`homepage.${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.homepage.entrypoints=websecure"
      - "traefik.http.routers.homepage.tls.certresolver=cloudflare"
      - "traefik.http.services.homepage.loadbalancer.server.port=3000"
      
      # auth
      - "traefik.http.routers.homepage.middlewares=authentik@docker"

  # refresh dynamic IP to cloudflare DNS
  ddclient:
    image: lscr.io/linuxserver/ddclient:latest
    container_name: ddclient
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - DDCLIENT_CLOUDFLARE_TOKEN=${DDCLIENT_CLOUDFLARE_TOKEN}
    volumes:
      - ./config/ddclient:/config
    restart: unless-stopped
    networks:
      - homelab
  # ----------------------------
  # NETWORK & ADMIN SERVICES
  # ----------------------------

  # SMB file sharing for Windows clients
  samba:
    container_name: samba
    image: dperson/samba
    volumes:
      - ${DATA}:/data
    environment:
      - USERID=${PUID}
      - GROUPID=${PGID}
      - TZ=${TZ}
    ports:
      - "137:137/udp"
      - "138:138/udp"
      - "139:139/tcp"
      - "445:445/tcp"
    command: >
      samba.sh
        -w "WORKGROUP"
        -s "data;/data;yes;no;no;all"
        -u "${SAMBA_USER};${SAMBA_PASSWORD}"
        -p
        -n
    restart: unless-stopped

  # Ad-blocking DNS server
  adguard:
    container_name: adguard
    image: adguard/adguardhome
    volumes:
      - ./config/adguard/work:/opt/adguardhome/work
      - ./config/adguard/conf:/opt/adguardhome/conf
      - ${CERT}:/cert
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    ports:
      - 53:53/tcp
      - 53:53/udp
      - 67:67/udp
      - 853:853/tcp
    depends_on:
      - traefik
      - traefik-certs-dumper
    restart: unless-stopped
    networks:
      - homelab
      - homelab_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=homelab_proxy"
      - "traefik.http.routers.adguard.rule=Host(`adguard.${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.adguard.entrypoints=websecure"
      - "traefik.http.routers.adguard.tls.certresolver=cloudflare"
      - "traefik.http.routers.adguard.middlewares=authentik@docker"
      - "traefik.http.services.adguard.loadbalancer.server.port=80"

  # Contaiers management UI
  portainer-ce:
    container_name: portainer
    image: portainer/portainer-ce
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./config/portainer:/data
    ports:
      - 8000:8000 # Agent
    restart: unless-stopped
    networks:
      - homelab
      - homelab_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=homelab_proxy"
      - "traefik.http.routers.portainer.rule=Host(`portainer.${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.portainer.entrypoints=websecure"
      - "traefik.http.routers.portainer.tls.certresolver=cloudflare"
      - "traefik.http.routers.portainer.middlewares=authentik@docker"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"

  # ----------------------------
  # BACKUP & RECOVERY
  # ----------------------------
  duplicati:
    image: lscr.io/linuxserver/duplicati:latest
    container_name: duplicati
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./config/duplicati:/config
      - ${BACKUP}:/backups
      - ${HOMESERVER}:/source
    restart: unless-stopped
    networks:
      - homelab
      - homelab_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=homelab_proxy"
      - "traefik.http.routers.duplicati.rule=Host(`duplicati.${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.duplicati.entrypoints=websecure"
      - "traefik.http.routers.duplicati.tls.certresolver=cloudflare"
      - "traefik.http.routers.duplicati.middlewares=authentik@docker"
      - "traefik.http.services.duplicati.loadbalancer.server.port=8200"

  # ----------------------------
  # INGRESS & SECURITY
  # ----------------------------

  authentik-redis:
    image: redis:7-alpine
    container_name: authentik-redis
    command: [ "redis-server", "--save", "60", "1", "--loglevel", "warning", "--requirepass", "${AUTHENTIK_REDIS__PASSWORD}" ]
    restart: unless-stopped
    volumes:
      - authentik_redis_data:/data
    networks:
      - homelab

  authentik-server:
    image: ghcr.io/goauthentik/server:2025.8.3
    container_name: authentik-server
    command: server
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      authentik-redis:
        condition: service_started
    environment:
      - AUTHENTIK_SECRET_KEY=${AUTHENTIK_SECRET_KEY}
      - AUTHENTIK_REDIS__HOST=${AUTHENTIK_REDIS__HOST}
      - AUTHENTIK_REDIS__PORT=${AUTHENTIK_REDIS__PORT}
      - AUTHENTIK_REDIS__PASSWORD=${AUTHENTIK_REDIS__PASSWORD}
      - AUTHENTIK_POSTGRESQL__HOST=${AUTHENTIK_POSTGRESQL__HOST}
      - AUTHENTIK_POSTGRESQL__PORT=${AUTHENTIK_POSTGRESQL__PORT}
      - AUTHENTIK_POSTGRESQL__USER=${AUTHENTIK_POSTGRESQL__USER}
      - AUTHENTIK_POSTGRESQL__PASSWORD=${AUTHENTIK_POSTGRESQL__PASSWORD}
      - AUTHENTIK_POSTGRESQL__NAME=${AUTHENTIK_POSTGRESQL__NAME}
      - AUTHENTIK_LOG_LEVEL=info
    volumes:
      - ./config/authentik/media:/media
      - ./config/authentik:/config
    networks:
      - homelab
      - homelab_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=homelab_proxy"

      # Authentik router itself
      - "traefik.http.routers.authentik.rule=Host(`authentik.${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.authentik.entrypoints=websecure"
      - "traefik.http.routers.authentik.tls.certresolver=cloudflare"
      - "traefik.http.services.authentik.loadbalancer.server.port=9000"
      
      # ForwardAuth middleware
      - "traefik.http.middlewares.authentik.forwardauth.address=http://authentik-server:9000/outpost.goauthentik.io/auth/traefik"
      - "traefik.http.middlewares.authentik.forwardauth.trustForwardHeader=true"
      - "traefik.http.middlewares.authentik.forwardauth.authResponseHeaders=authorization,X-authentik-username,X-authentik-groups,X-authentik-entitlements,X-authentik-email,X-authentik-name,X-authentik-uid,X-authentik-jwt,X-authentik-meta-jwks,X-authentik-meta-outpost,X-authentik-meta-provider,X-authentik-meta-app,X-authentik-meta-version"

  authentik-worker:
    image: ghcr.io/goauthentik/server:2025.8.3
    container_name: authentik-worker
    command: worker
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      authentik-redis:
        condition: service_started
    environment:
      - AUTHENTIK_SECRET_KEY=${AUTHENTIK_SECRET_KEY}
      - AUTHENTIK_REDIS__HOST=${AUTHENTIK_REDIS__HOST}
      - AUTHENTIK_REDIS__PORT=${AUTHENTIK_REDIS__PORT}
      - AUTHENTIK_REDIS__PASSWORD=${AUTHENTIK_REDIS__PASSWORD}
      - AUTHENTIK_POSTGRESQL__HOST=${AUTHENTIK_POSTGRESQL__HOST}
      - AUTHENTIK_POSTGRESQL__PORT=${AUTHENTIK_POSTGRESQL__PORT}
      - AUTHENTIK_POSTGRESQL__USER=${AUTHENTIK_POSTGRESQL__USER}
      - AUTHENTIK_POSTGRESQL__PASSWORD=${AUTHENTIK_POSTGRESQL__PASSWORD}
      - AUTHENTIK_POSTGRESQL__NAME=${AUTHENTIK_POSTGRESQL__NAME}
      - AUTHENTIK_LOG_LEVEL=info
    volumes:
      - ./config/authentik/media:/media
      - ./config/authentik:/config
    networks:
      - homelab

  # Reverse proxy, dashboard & certificates
  traefik:
    image: traefik:latest
    container_name: traefik
    restart: unless-stopped
    command:
      - --api.dashboard=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.network=homelab_proxy
      - --entrypoints.web.address=:80
      - --entrypoints.web.http.redirections.entryPoint.to=websecure
      - --entrypoints.web.http.redirections.entryPoint.scheme=https
      - --entrypoints.web.http.redirections.entryPoint.permanent=true
      - --entrypoints.websecure.address=:443

      # ðŸ‘‡ Tell Traefik to request one cert for root + wildcard on websecure
      - --entrypoints.websecure.http.tls.domains[0].main=antoineglacet.com
      - --entrypoints.websecure.http.tls.domains[0].sans=*.antoineglacet.com

      # ACME (DNS-01 via Cloudflare)
      - --certificatesresolvers.cloudflare.acme.email=${TRAEFIK_ACME_EMAIL}
      - --certificatesresolvers.cloudflare.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.cloudflare.acme.dnschallenge.provider=cloudflare
      - --certificatesresolvers.cloudflare.acme.dnschallenge.delaybeforecheck=10
      - --certificatesresolvers.cloudflare.acme.dnschallenge.resolvers=1.1.1.1:53,8.8.8.8:53
      - --log.level=INFO
    environment:
      - CLOUDFLARE_DNS_API_TOKEN=${TRAEFIK_CLOUDFLARE_TOKEN}
      - TRAEFIK_DOMAIN=${TRAEFIK_DOMAIN}
    ports:
      - 80:80
      - 443:443
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./config/traefik/letsencrypt:/letsencrypt
    extra_hosts:
      - "host.docker.internal:host-gateway" # this is for containers running in network_mode: host
    networks:
      - homelab
      - homelab_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=homelab_proxy"
      - "traefik.http.routers.traefik.rule=Host(`traefik.${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls.certresolver=cloudflare"
      - "traefik.http.routers.traefik.middlewares=authentik@docker"
      - "traefik.http.routers.traefik.service=api@internal"

  traefik-certs-dumper:
    image: ldez/traefik-certs-dumper:v2.9.1
    container_name: traefik-certs-dumper
    command:
      - file
      - --source
      - /letsencrypt/acme.json
      - --dest
      - /output
      - --domain-subdir=true
      - --watch
    restart: unless-stopped
    depends_on:
      - traefik
    volumes:
      - ./config/traefik/letsencrypt:/letsencrypt
      - ./config/traefik/certs:/output

  # Authentication
  authelia:
    image: ghcr.io/authelia/authelia:latest
    container_name: authelia
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - AUTHELIA_JWT_SECRET=${AUTHELIA_JWT_SECRET}
      - AUTHELIA_SESSION_SECRET=${AUTHELIA_SESSION_SECRET}
      - AUTHELIA_STORAGE_ENCRYPTION_KEY=${AUTHELIA_STORAGE_ENCRYPTION_KEY}
      - AUTHELIA_SMTP_PASSWORD=${AUTHELIA_SMTP_PASSWORD}
    volumes:
      - ./config/authelia:/config
    restart: unless-stopped
    networks:
      - homelab
      - homelab_proxy
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=homelab_proxy"
      - "traefik.http.routers.authelia.rule=Host(`auth.${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.authelia.entrypoints=websecure"
      - "traefik.http.routers.authelia.tls.certresolver=cloudflare"
      - "traefik.http.services.authelia.loadbalancer.server.port=9091"
      - "traefik.http.middlewares.authelia.forwardauth.address=http://authelia:9091/api/verify?rd=https://auth.${TRAEFIK_DOMAIN}/"
      - "traefik.http.middlewares.authelia.forwardauth.trustForwardHeader=true"
      - "traefik.http.middlewares.authelia.forwardauth.authResponseHeaders=Remote-User,Remote-Groups,Remote-Name,Remote-Email"

  # Restart containers based on health
  autoheal:
    image: willfarrell/autoheal
    container_name: autoheal
    environment:
      - AUTOHEAL_CONTAINER_LABEL=all
    volumes:
      # docker socket, be careful with this
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped

# not sure why we only use this for appflowy stuff  
volumes:
  postgres_data:
  minio_data:
  authentik_redis_data:
  pgadmin_data:
